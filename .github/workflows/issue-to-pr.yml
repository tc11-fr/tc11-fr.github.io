name: Issue to Markdown PR

on:
  issues:
    types: [opened, edited]

jobs:
  issue-to-pr:
    if: contains(join(github.event.issue.labels.*.name, ','), 'contenu')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Générer le fichier Markdown depuis l’issue
        id: generate
        run: |
          TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH" | sed 's/^\[Page\] //')"
          BODY="$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")"
          echo "BODY:"
          echo "$BODY"
          extract_block() {
            awk -v header="$1" '
              $0 ~ header {
                getline
                block = ""
                while (getline && $0 !~ /^### - /) {
                  block = block $0 "\n"
                }
                print block
                exit
              }
            '
          }
          TITRE="$(echo "$BODY" | extract_block '^### - Titre de la page')"
          CONTENU="$(echo "$BODY" | extract_block '^### - Contenu.*')"
          CATEGORIE="$(echo "$BODY" | extract_block '^### - Catégorie')"
          LABELBOUTON="$(echo "$BODY" | extract_block '^### - Label du bouton.*')"
          # Nettoyer les retours à la ligne en trop
          TITRE="$(echo "$TITRE" | sed '/^\s*$/d')"
          CONTENU="$(echo "$CONTENU" | sed '/^\s*$/d')"
          CATEGORIE="$(echo "$CATEGORIE" | sed '/^\s*$/d')"
          LABELBOUTON="$(echo "$LABELBOUTON" | sed '/^\s*$/d')"
          echo "Titre : $TITRE"
          echo "Contenu : $CONTENU"
          echo "Catégorie : $CATEGORIE"
          echo "Label du bouton : $LABELBOUTON"
          # Générer la date courante au format yyyy-mm-dd
          DATE="$(date +%F)"
          # Générer le nom du dossier et du fichier
          FOLDERNAME="content/posts/$DATE"-$(echo "$TITRE" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          FILENAME="$FOLDERNAME/index.md"
          mkdir -p "$FOLDERNAME"
          # Générer le front matter et le contenu
          cat > "$FILENAME" <<EOF
          ---
          title: "$TITRE"
          category: "$CATEGORIE"
          date: "$DATE"
          layout: layouts/post.html
          labelDetails: "$LABELBOUTON"
          ---
          $CONTENU
          EOF
      - name: Créer la Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "Ajout d’une page depuis une issue"
          branch: issue-page-${{ github.event.issue.number }}
          title: "Ajout d’une page : ${{ github.event.issue.title }}"
          body: "Page générée automatiquement depuis l’issue #${{ github.event.issue.number }}."
          add-paths: content/posts/*.md