name: Issue to Markdown PR

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: preview-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  issue-to-pr:
    if: contains(join(github.event.issue.labels.*.name, ','), 'contenu')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: GÃ©nÃ©rer le fichier Markdown depuis lâ€™issue
        id: generate
        run: |
          TITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH" | sed 's/^\[Page\] //')"
          BODY="$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")"
          extract_block() {
            awk -v header="$1" '
              $0 ~ header {
                getline
                block = ""
                while (getline && $0 !~ /^### - /) {
                  block = block $0 "\n"
                }
                print block
                exit
              }
            '
          }
          TITRE="$(echo "$BODY" | extract_block '^### - Titre de la page' | sed '/^\s*$/d')"
          CONTENU="$(echo "$BODY" | extract_block '^### - Contenu.*' | sed '/^\s*$/d')"
          CATEGORIE="$(echo "$BODY" | extract_block '^### - CatÃ©gorie' | sed '/^\s*$/d')"
          LABELBOUTON="$(echo "$BODY" | extract_block '^### - Label du bouton.*' | sed '/^\s*$/d')"

          DATE="$(date +%F)"
          SLUG="$(echo "$TITRE" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')"
          FOLDERNAME="content/posts/$DATE-$SLUG"
          FILENAME="$FOLDERNAME/index.md"
          mkdir -p "$FOLDERNAME"
          cat > "$FILENAME" <<EOF
          ---
          title: "$TITRE"
          category: "$CATEGORIE"
          date: "$DATE"
          layout: layouts/post.html
          labelDetails: "$LABELBOUTON"
          ---
          $CONTENU
          EOF

          BRANCH="issue-page-${{ github.event.issue.number }}"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "folder_path=$FOLDERNAME" >> "$GITHUB_OUTPUT"
          echo "file_path=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "folder_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/tree/$BRANCH/$FOLDERNAME" >> "$GITHUB_OUTPUT"
          echo "file_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/blob/$BRANCH/$FILENAME" >> "$GITHUB_OUTPUT"
          echo "upload_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/upload/$BRANCH/$FOLDERNAME" >> "$GITHUB_OUTPUT"

      - name: CrÃ©er / mettre Ã  jour la Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Ajout dâ€™une page depuis une issue"
          branch: ${{ steps.generate.outputs.branch }}
          title: "Ajout dâ€™une page : ${{ github.event.issue.title }}"
          add-paths: content/posts/**/*.md
          body: |
            Page gÃ©nÃ©rÃ©e automatiquement depuis lâ€™issue #${{ github.event.issue.number }}.

            **Dossier du post :** [`${{ steps.generate.outputs.folder_path }}`](${{ steps.generate.outputs.folder_url }})  
            **Fichier :** [`index.md`](${{ steps.generate.outputs.file_url }})

            **Ajouter des images / piÃ¨ces jointes (Roq les dÃ©tecte automatiquement) :**  
            âžœ [DÃ©poser des fichiers dans ce dossier](${{ steps.generate.outputs.upload_url }})

      # -------- Build & Deploy aprÃ¨s crÃ©ation/MAJ PR --------

      - name: DÃ©finir PR_NUMBER
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        run: echo "PR_NUMBER=${{ steps.cpr.outputs.pull-request-number }}" >> $GITHUB_ENV

      - name: Checkout la branche de la PR
        if: ${{ env.PR_NUMBER != '' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.generate.outputs.branch }}

      - name: Set up JDK 21 (cache Maven)
        if: ${{ env.PR_NUMBER != '' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      # (Optionnel) Prime le cache pour des builds trÃ¨s rapides ensuite
      - name: Prime Maven cache (go-offline)
        if: ${{ env.PR_NUMBER != '' }}
        run: ./mvnw -B -q -DskipTests dependency:go-offline

      # (Optionnel) Cache npm global pour l'install de surge
      - name: Cache npm (global)
        if: ${{ env.PR_NUMBER != '' }}
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-global-v1
          restore-keys: |
            ${{ runner.os }}-npm-global-

      - name: Setup Node.js
        if: ${{ env.PR_NUMBER != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Surge
        if: ${{ env.PR_NUMBER != '' }}
        run: npm install -g surge

      # Choisis lâ€™une des deux lignes suivantes selon ton besoin :
      # (A) GÃ©nÃ©ration directe du site (plus rapide si ton plugin le supporte)
      # - name: Build Roq site (generate-only)
      #   if: ${{ env.PR_NUMBER != '' }}
      #   run: QUARKUS_ROQ_GENERATOR_BATCH=true ./mvnw -B -q -DskipTests -Dspotless.skip=true -Dcheckstyle.skip=true quarkus:roq-generate-site

      # (B) Build â€œpackage + runâ€ (moins rapide)
      - name: Build Roq site (package + run)
        if: ${{ env.PR_NUMBER != '' }}
        run: |
          QUARKUS_ROQ_GENERATOR_BATCH=true \
          ./mvnw -B -q \
            -DskipTests -DskipITs \
            -Dmaven.javadoc.skip=true \
            -Dspotless.skip=true -Dcheckstyle.skip=true \
            package quarkus:run

      - name: Deploy to Surge
        if: ${{ env.PR_NUMBER != '' }}
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        run: |
          export DEPLOY_DOMAIN=https://pr-${{ env.PR_NUMBER }}-roq-preview.surge.sh
          # adapte le dossier si tu utilises la gÃ©nÃ©ration "A"
          surge ./target/roq --domain $DEPLOY_DOMAIN --token $SURGE_TOKEN
          echo "DEPLOY_DOMAIN=$DEPLOY_DOMAIN" >> $GITHUB_ENV

      - name: Commenter la PR avec le lien de preview
        if: ${{ env.PR_NUMBER != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const url = process.env.DEPLOY_DOMAIN || 'preview non disponible';
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview Roq : [${url}](${url})`
            });
